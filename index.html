<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>駕駛小幫手 (全台真實數據版)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body, html { height: 100%; margin: 0; overflow: hidden; }
        #map { height: 100%; width: 100%; z-index: 0; }
        .pulse-marker { animation: pulse-ring 2s cubic-bezier(0.215, 0.61, 0.355, 1) infinite; }
        @keyframes pulse-ring {
            0% { transform: scale(0.33); opacity: 1; }
            80%, 100% { transform: scale(2); opacity: 0; }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans flex flex-col relative">

    <header class="bg-slate-800 text-white p-4 shadow-md z-20 flex justify-between items-center flex-none">
        <div class="flex items-center gap-2">
            <i data-lucide="navigation" class="w-6 h-6 text-blue-400"></i>
            <h1 class="text-lg font-bold">駕駛小幫手 (全台真實版)</h1>
        </div>
        <div id="gps-status" class="text-xs bg-slate-700 px-2 py-1 rounded text-gray-300">
            等待 GPS...
        </div>
    </header>

    <div id="alert-banner" class="hidden bg-red-600 text-white px-4 py-3 animate-pulse flex items-center justify-center gap-2 z-30 font-bold text-lg shadow-lg absolute top-[60px] left-0 right-0">
        <i data-lucide="alert-triangle" class="w-8 h-8"></i>
        <span id="alert-text"></span>
    </div>
    
    <div id="toast-message" class="hidden absolute top-[120px] left-1/2 transform -translate-x-1/2 bg-slate-800/90 text-white px-4 py-2 rounded shadow-lg z-50 text-sm transition-opacity duration-300 pointer-events-none text-center min-w-[200px]">
        狀態訊息
    </div>

    <div id="map" class="flex-1"></div>

    <div id="loading-indicator" class="hidden absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-black/70 text-white px-4 py-2 rounded-lg z-50 flex items-center gap-2">
        <div class="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"></div>
        <span>資料更新中...</span>
    </div>

    <div class="absolute bottom-8 left-0 right-0 px-4 z-20 flex justify-center pointer-events-none">
        <button id="btn-start" class="pointer-events-auto bg-blue-600 hover:bg-blue-700 text-white px-8 py-4 rounded-full shadow-xl font-bold text-lg flex items-center gap-2 transition-transform active:scale-95">
            <i data-lucide="locate-fixed"></i> 開始導航模式
        </button>

        <div id="status-panel" class="hidden pointer-events-auto bg-white/95 backdrop-blur px-6 py-3 rounded-full shadow-lg border border-gray-200 text-gray-700 font-medium flex items-center">
            <span>正在監控全台路況...</span>
            <button id="btn-stop" class="ml-3 text-red-500 font-bold text-sm underline">停止</button>
        </div>
    </div>

    <div class="absolute top-20 right-4 z-20 bg-white/80 p-2 rounded text-xs shadow max-w-[150px]">
        <p class="font-bold text-gray-500 mb-1">功能選單</p>
        <div id="debug-info" class="text-[10px] text-gray-400 mb-1 break-words">尚未定位</div>
        <button onclick="refreshAllData()" class="block w-full text-left p-1 mt-1 hover:bg-gray-200 rounded text-blue-600 font-bold">
            ↻ 強制更新周邊資料
        </button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        // --- 初始化變數 ---
        let map;
        let userMarker, accuracyCircle;
        let parkingLayer, cameraLayer; 
        let watchId = null;
        let isTracking = false;
        let hasFetchedInitialLocation = false;
        let currentLat = 22.997; // 預設台南
        let currentLng = 120.212;
        let nearbyCamerasList = []; // 儲存下載下來的相機資料，供即時比對

        // ▼▼▼ 請務必填入您剛剛部署的新版 GAS 網址 ▼▼▼
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbyHzKgk3xYAoQMLOKmw859IixhNGFTw0g9jlnGmpGifimQbcRJC5kWt0uXnBZFGXG4T7w/exec";
        
        // 圖示設定
        const createIcon = (color, size=35) => {
            const svg = `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="${color}" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                <circle cx="12" cy="10" r="3"></circle>
            </svg>`;
            return L.icon({
                iconUrl: `data:image/svg+xml;base64,${btoa(svg)}`,
                iconSize: [size, size],
                iconAnchor: [size/2, size],
                popupAnchor: [1, -size],
            });
        };
        const icons = {
            user: createIcon('#3B82F6'),    // 藍色
            parking: createIcon('#10B981'), // 綠色
            camera: createIcon('#F59E0B', 40)   // 黃色(大一點)
        };

        // --- 初始化 ---
        window.onload = function() {
            lucide.createIcons();
            map = L.map('map', { zoomControl: false }).setView([currentLat, currentLng], 14);
            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '© OpenStreetMap' }).addTo(map);

            parkingLayer = L.layerGroup().addTo(map);
            cameraLayer = L.layerGroup().addTo(map);

            map.on('moveend', function() {
                const center = map.getCenter();
                currentLat = center.lat;
                currentLng = center.lng;
                updateDebugInfo(currentLat, currentLng);
            });

            document.getElementById('btn-start').addEventListener('click', startTracking);
            document.getElementById('btn-stop').addEventListener('click', stopTracking);
            
            showToast("請點擊「開始導航模式」以取得真實資料", 'info');
        };

        function updateDebugInfo(lat, lng) {
            document.getElementById('debug-info').innerText = `Lat: ${lat.toFixed(4)}\nLng: ${lng.toFixed(4)}`;
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast-message');
            toast.innerText = message;
            toast.className = "hidden absolute top-[120px] left-1/2 transform -translate-x-1/2 px-4 py-2 rounded shadow-lg z-50 text-sm transition-opacity duration-300 pointer-events-none text-center min-w-[200px] text-white";
            
            if (type === 'error') toast.classList.add('bg-red-600', 'block');
            else if (type === 'warning') toast.classList.add('bg-yellow-600/90', 'block');
            else toast.classList.add('bg-slate-800/90', 'block');
            
            setTimeout(() => { toast.classList.add('hidden'); toast.classList.remove('block'); }, 4000);
        }

        // --- 資料串接核心 ---
        
        // 整合更新 (停車場 + 測速照相)
        window.refreshAllData = function() {
            fetchParkingData(currentLat, currentLng);
            fetchCameraData(currentLat, currentLng);
        }

        // 1. 抓取停車場
        async function fetchParkingData(lat, lng) {
            try {
                // type=parking
                const response = await fetch(`${GAS_API_URL}?type=parking&lat=${lat}&lng=${lng}`);
                const data = await response.json();
                
                if (data.error) throw new Error(data.error);
                
                parkingLayer.clearLayers();
                const parkings = data.ParkingAvailabilities || [];
                
                parkings.forEach(park => {
                    if (park.ParkingPosition?.PositionLat && park.ParkingPosition?.PositionLon) {
                        const avail = park.AvailableSpaces;
                        const name = park.CarParkName?.Zh_tw || park.CarParkName;
                        let colorClass = avail < 5 ? "text-red-600" : "text-green-600";
                        
                        // 換成紅色圖示如果車位少
                        let icon = avail < 5 ? createIcon('#EF4444') : icons.parking;

                        const popup = `
                            <div class="p-1 min-w-[150px]">
                                <h3 class="font-bold text-base">${name}</h3>
                                <p class="mb-2">剩餘: <span class="${colorClass} font-bold text-lg">${avail}</span> / ${park.TotalSpaces}</p>
                                <button onclick="navigateTo(${park.ParkingPosition.PositionLat}, ${park.ParkingPosition.PositionLon})" 
                                    class="w-full bg-blue-600 text-white py-2 rounded text-sm">導航前往</button>
                            </div>`;
                        
                        L.marker([park.ParkingPosition.PositionLat, park.ParkingPosition.PositionLon], {icon: icon})
                         .bindPopup(popup).addTo(parkingLayer);
                    }
                });
                
                if(parkings.length > 0) showToast(`已更新 ${parkings.length} 筆停車場`);
            } catch (e) {
                console.error("Parking Error:", e);
                // 失敗時不清除舊資料，只顯示錯誤
            }
        }

        // 2. 抓取測速照相 (新功能)
        async function fetchCameraData(lat, lng) {
            const loading = document.getElementById('loading-indicator');
            loading.classList.remove('hidden');
            
            try {
                // type=camera
                const response = await fetch(`${GAS_API_URL}?type=camera&lat=${lat}&lng=${lng}`);
                const data = await response.json();

                if (data.error) throw new Error(data.error);

                cameraLayer.clearLayers();
                nearbyCamerasList = data.cameras || []; // 更新全域變數供即時比對

                nearbyCamerasList.forEach(cam => {
                    const popup = `
                        <div class="p-1 min-w-[150px]">
                            <h3 class="font-bold text-base text-red-600">⚠️ 測速照相</h3>
                            <p class="text-sm font-bold">限速: ${cam.limit} km/h</p>
                            <p class="text-xs text-gray-600 mb-2">${cam.address}</p>
                            <p class="text-xs text-gray-500">方向: ${cam.direct || '無資料'}</p>
                        </div>`;
                    
                    L.marker([cam.lat, cam.lng], {icon: icons.camera})
                     .bindPopup(popup).addTo(cameraLayer);
                });

                if(nearbyCamerasList.length > 0) showToast(`已載入 ${nearbyCamerasList.length} 支測速照相`, 'warning');
                else showToast("附近 3 公里內無固定測速照相");

            } catch (e) {
                console.error("Camera Error:", e);
                showToast("測速資料下載失敗", 'error');
            } finally {
                loading.classList.add('hidden');
            }
        }

        // --- 距離計算與警示 ---
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; 
            const φ1 = lat1 * Math.PI / 180;
            const φ2 = lat2 * Math.PI / 180;
            const Δφ = (lat2 - lat1) * Math.PI / 180;
            const Δλ = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) + Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ/2) * Math.sin(Δλ/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function checkSpeedCameras(userLat, userLng) {
            const alertBanner = document.getElementById('alert-banner');
            const alertText = document.getElementById('alert-text');
            
            // 使用後端回傳的 nearbyCamerasList 進行比對
            const nearby = nearbyCamerasList.find(cam => {
                const dist = getDistance(userLat, userLng, cam.lat, cam.lng);
                return dist < 350; // 350公尺內警示
            });

            if (nearby) {
                alertBanner.classList.remove('hidden');
                alertText.innerText = `⚠️ 前方 ${nearby.limit} 公里測速照相！`;
            } else {
                alertBanner.classList.add('hidden');
            }
        }

        // --- 定位與導航 ---
        window.navigateTo = (lat, lng) => window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}&travelmode=driving`, '_blank');

        function startTracking() {
            if (!navigator.geolocation) return alert("不支援定位");
            document.getElementById('btn-start').classList.add('hidden');
            document.getElementById('status-panel').classList.remove('hidden');
            isTracking = true;
            watchId = navigator.geolocation.watchPosition(updatePosition, 
                (err) => document.getElementById('gps-status').innerText = "GPS 訊號遺失", 
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        }

        function stopTracking() {
            if (watchId !== null) navigator.geolocation.clearWatch(watchId);
            isTracking = false;
            document.getElementById('btn-start').classList.remove('hidden');
            document.getElementById('status-panel').classList.add('hidden');
            document.getElementById('gps-status').innerText = "已停止追蹤";
        }

        function updatePosition(pos) {
            const { latitude: lat, longitude: lng, accuracy } = pos.coords;
            currentLat = lat; currentLng = lng;
            updateDebugInfo(lat, lng);

            document.getElementById('gps-status').innerText = `GPS 良好 (±${Math.round(accuracy)}m)`;

            if (!userMarker) {
                userMarker = L.marker([lat, lng], {icon: icons.user}).addTo(map);
                accuracyCircle = L.circle([lat, lng], {radius: 300, color: 'blue', opacity: 0.1}).addTo(map);
                map.setView([lat, lng], 16);
                if (!hasFetchedInitialLocation) {
                    refreshAllData(); // 第一次定位成功，抓資料
                    hasFetchedInitialLocation = true;
                }
            } else {
                userMarker.setLatLng([lat, lng]);
                accuracyCircle.setLatLng([lat, lng]);
            }
            
            // 如果移動超過 1 公里，重新抓取背景資料 (避免太頻繁呼叫 API)
            // (這裡簡化處理：先只做警示檢測)
            checkSpeedCameras(lat, lng);
        }
    </script>
</body>
</html>